name: CI/CD Pipeline

on:
    push:
        branches: [main]

jobs:
    terraform:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v3
            - name: Setup Terraform
              uses: hashicorp/setup-terraform@v2
            - name: Terraform Apply
              env:
                  AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
                  AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
              run: |
                  cd terraform
                  terraform init
                  terraform apply -auto-approve

    # 階段 2: Docker 打包與推送
    build-and-push:
        needs: terraform
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v3
            - name: Docker Login
              uses: docker/login-action@v2
              with:
                  username: ${{ secrets.DOCKER_USERNAME }}
                  password: ${{ secrets.DOCKER_PASSWORD }}
            - name: Build and Push
              run: |
                  docker build -t ${{ secrets.DOCKER_USERNAME }}/monitoring-app:latest -f docker/Dockerfile .
                  docker push ${{ secrets.DOCKER_USERNAME }}/monitoring-app:latest

    # 階段 3: SSH 部署
    deploy:
        needs: build-and-push
        runs-on: ubuntu-latest
        steps:
            - name: Deploy via SSH
              uses: appleboy/ssh-action@master
              with:
                  host: ${{ secrets.EC2_HOST }}
                  username: ec2-user
                  key: ${{ secrets.EC2_SSH_KEY }}
                  script: |
                      # 進入對應的 cloud-native 目錄
                      cd ~/cloud-native
                      docker-compose pull
                      docker-compose up -d --force-recreate
