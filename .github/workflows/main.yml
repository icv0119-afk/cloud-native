name: CI/CD Pipeline

on:
  push:
    branches: [main]

jobs:
  # terraform:
  #     name: Infrastructure Management
  #     runs-on: ubuntu-latest
  #     steps:
  #         - name: Checkout Code
  #           uses: actions/checkout@v3

  #         - name: Setup Terraform
  #           uses: hashicorp/setup-terraform@v2

  #         - name: Terraform Init & Apply
  #           env:
  #               AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
  #               AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
  #           run: |
  #               cd terraform
  #               terraform init
  #               terraform apply -auto-approve

  build-and-push:
    name: Docker Image Build & Push
    #    needs: terraform
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Docker Hub Login
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and Push to Docker Hub
        uses: docker/build-push-action@v4
        with:
          context: .
          file: docker/Dockerfile
          push: true
          tags: vic0119/cloud-native:latest

  deploy:
    name: Deploy to EC2
    needs: build-and-push
    runs-on: ubuntu-latest
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ec2-user
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            echo "--- 清理環境 ---"
            sudo docker stop $(sudo docker ps -aq) || true
            sudo docker rm $(sudo docker ps -aq) || true
            if [ ! -f /usr/local/bin/docker-compose ]; then
                echo "正在安裝 Docker Compose..."
                sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
                sudo chmod +x /usr/local/bin/docker-compose
            fi
            mkdir -p ~/cloud-native/docker
            cd ~/cloud-native

            cat <<EOF > docker/nginx.conf
            server {
                listen 80;
                location / {
                    proxy_pass http://app:8000;
                    proxy_set_header Host \$host;
                    proxy_set_header X-Real-IP \$remote_addr;
                    proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
                }
            }
            EOF
            cat <<EOF > docker-compose.yml
            version: '3.8'
            services:
              app:
                image: vic0119/cloud-native:latest
                expose:
                  - "8000"
                restart: always

              nginx:
                image: nginx:alpine
                ports:
                  - "80:80"
                volumes:
                  - ./docker/nginx.conf:/etc/nginx/conf.d/default.conf:ro
                depends_on:
                  - app
            EOF
            echo "正在使用 Docker Compose 啟動服務..."
            sudo /usr/local/bin/docker-compose pull
            sudo /usr/local/bin/docker-compose up -d --force-recreate
            echo "部署完成！目前運行的容器狀況："
            sudo docker ps
