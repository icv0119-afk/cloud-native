name: CI/CD Pipeline

on:
    push:
        branches: [main]

jobs:
    terraform:
        name: Infrastructure Management
        runs-on: ubuntu-latest
        steps:
            - name: Checkout Code
              uses: actions/checkout@v3

            - name: Setup Terraform
              uses: hashicorp/setup-terraform@v2

            - name: Terraform Init & Apply
              env:
                  AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
                  AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
              run: |
                  cd terraform
                  terraform init
                  terraform apply -auto-approve

    build-and-push:
        name: Docker Image Build & Push
        needs: terraform
        runs-on: ubuntu-latest
        steps:
            - name: Checkout Code
              uses: actions/checkout@v3

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v2

            - name: Docker Hub Login
              uses: docker/login-action@v2
              with:
                  username: ${{ secrets.DOCKER_USERNAME }}
                  password: ${{ secrets.DOCKER_PASSWORD }}

            - name: Build and Push to Docker Hub
              uses: docker/build-push-action@v4
              with:
                  context: .
                  file: docker/dockerfile
                  push: true
                  tags: vic0119/cloud-native:latest

    deploy:
        name: Deploy to EC2
        needs: build-and-push
        runs-on: ubuntu-latest
        steps:
            - name: Deploy via SSH
              uses: appleboy/ssh-action@master
              with:
                  host: ${{ secrets.EC2_HOST }}
                  username: ec2-user
                  key: ${{ secrets.EC2_SSH_KEY }}
                  script: |
                      # 確保專案目錄存在
                      mkdir -p ~/cloud-native
                      cd ~/cloud-native

                      # 從 GitHub 獲取最新的 docker-compose.yml 內容 (確保連動更新)
                      # 這裡也可以考慮使用 git pull，但直接拉取 image 是更簡單的做法

                      # 停止並移除舊容器
                      sudo docker compose down || true

                      # 拉取最新映像檔並背景執行
                      sudo docker compose pull
                      sudo docker compose up -d --force-recreate
