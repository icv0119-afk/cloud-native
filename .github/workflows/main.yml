name: CI/CD Pipeline

on:
    push:
        branches: [main]

jobs:
    # terraform:
    #     name: Infrastructure Management
    #     runs-on: ubuntu-latest
    #     steps:
    #         - name: Checkout Code
    #           uses: actions/checkout@v3

    #         - name: Setup Terraform
    #           uses: hashicorp/setup-terraform@v2

    #         - name: Terraform Init & Apply
    #           env:
    #               AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
    #               AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
    #           run: |
    #               cd terraform
    #               terraform init
    #               terraform apply -auto-approve

    build-and-push:
        name: Docker Image Build & Push
        #    needs: terraform
        runs-on: ubuntu-latest
        steps:
            - name: Checkout Code
              uses: actions/checkout@v3

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v2

            - name: Docker Hub Login
              uses: docker/login-action@v2
              with:
                  username: ${{ secrets.DOCKER_USERNAME }}
                  password: ${{ secrets.DOCKER_PASSWORD }}

            - name: Build and Push to Docker Hub
              uses: docker/build-push-action@v4
              with:
                  context: .
                  file: docker/Dockerfile
                  push: true
                  tags: vic0119/cloud-native:latest

    deploy:
        name: Deploy to EC2
        needs: build-and-push
        runs-on: ubuntu-latest
        steps:
            - name: Deploy via SSH
              uses: appleboy/ssh-action@master
              with:
                  host: ${{ secrets.EC2_HOST }}
                  username: ec2-user
                  key: ${{ secrets.EC2_SSH_KEY }}
                  script: |
                      echo "--- 開始部署程序 ---"
                      if [ ! -f /usr/local/bin/docker-compose ]; then
                          echo "正在安裝 Docker Compose..."
                          sudo curl -L "https://github.com/docker/compose/releases/latest/download/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
                          sudo chmod +x /usr/local/bin/docker-compose
                      fi
                      mkdir -p ~/cloud-native
                      cd ~/cloud-native

                      cat <<EOF > docker-compose.yml
                      version: '3.8'
                      services:
                        app:
                          image: vic0119/cloud-native:latest
                          ports:
                            - "80:8000"
                          restart: always
                      EOF
                      echo "正在更新容器服務..."
                      sudo /usr/local/bin/docker-compose down --remove-orphans || true
                      sudo /usr/local/bin/docker-compose pull
                      sudo /usr/local/bin/docker-compose up -d --force-recreate
                      echo "部署完成"
                      sudo docker ps
